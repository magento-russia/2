<?xml version='1.0'?>
<config>
	<modules>
		<Df_Reward>
			<version>2.20.6</version>
			<author>Дмитрий Федюк</author>
		</Df_Reward>
	</modules>
	<global>
		<blocks><df_reward><class>Df_Reward_Block</class></df_reward></blocks>
		<helpers><df_reward><class>Df_Reward_Helper</class></df_reward></helpers>
		<models>
			<df_reward>
				<class>Df_Reward_Model</class>
				<resourceModel>df_reward_resource</resourceModel>
			</df_reward>
			<df_reward_resource>
				<class>Df_Reward_Model_Resource</class>
				<entities>
					<reward><table>df_reward</table></reward>
					<reward_history><table>df_reward_history</table></reward_history>
					<reward_rate><table>df_reward_rate</table></reward_rate>
					<reward_salesrule><table>df_reward_salesrule</table></reward_salesrule>
				</entities>
			</df_reward_resource>
		</models>
		<resources>
			<df_reward_setup>
				<setup>
					<module>Df_Reward</module>
					<class>Df_Core_Model_Resource_Setup</class>
				</setup>
			</df_reward_setup>
		</resources>
		<template>
			<email>
				<df_reward_notification_balance_update_template
					translate='label'
					module='df_reward'
				>
					<label>Reward Points Balance Update</label>
					<file>df/customer/points/updated.html</file>
					<type>html</type>
				</df_reward_notification_balance_update_template>
				<df_reward_notification_expiry_warning_template
					translate='label' 
					module='df_reward'
				>
					<label>Reward Points Expiry Warning</label>
					<file>df/customer/points/expiration_warning.html</file>
					<type>html</type>
				</df_reward_notification_expiry_warning_template>
			</email>
		</template>
		<sales>
			<quote>
				<totals>
					<reward>
						<class>df_reward/total_quote_reward</class>
						<after>wee,discount,tax,tax_subtotal,grand_total</after>
						<before>giftcardaccount,customerbalance</before>
						<renderer>df_reward/checkout_total</renderer>
					</reward>
				</totals>
			</quote>
			<order_invoice>
				<totals>
					<reward>
						<class>df_reward/total_invoice_reward</class>
					</reward>
				</totals>
			</order_invoice>
			<order_creditmemo>
				<totals>
					<reward>
						<class>df_reward/total_creditmemo_reward</class>
					</reward>
				</totals>
			</order_creditmemo>
		</sales>
		<fieldsets>
			<sales_convert_quote_address>
				<reward_points_balance><to_order>*</to_order></reward_points_balance>
				<reward_currency_amount><to_order>*</to_order></reward_currency_amount>
				<base_reward_currency_amount><to_order>*</to_order></base_reward_currency_amount>
			</sales_convert_quote_address>
		</fieldsets>
		<events>
			<newsletter_subscriber_save_commit_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>customerSubscribed</method>
					</df_reward>
				</observers>
			</newsletter_subscriber_save_commit_after>
			<sales_order_save_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>orderCompleted</method>
					</df_reward>
				</observers>
			</sales_order_save_after>
			<sales_quote_collect_totals_before>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>quoteCollectTotalsBefore</method>
					</df_reward>
				</observers>
			</sales_quote_collect_totals_before>
			<sales_quote_merge_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>quoteMergeAfter</method>
					</df_reward>
				</observers>
			</sales_quote_merge_after>
			<sales_order_load_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>orderLoadAfter</method>
					</df_reward>
				</observers>
			</sales_order_load_after>
			<sales_order_invoice_save_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>invoiceSaveAfter</method>
					</df_reward>
				</observers>
			</sales_order_invoice_save_after>
			<sales_order_invoice_save_commit_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>applyRewardSalesrulePoints</method>
					</df_reward>
				</observers>
			</sales_order_invoice_save_commit_after>
			<sales_order_creditmemo_refund>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>creditmemoRefund</method>
					</df_reward>
				</observers>
			</sales_order_creditmemo_refund>
			<sales_order_creditmemo_save_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>creditmemoSaveAfter</method>
					</df_reward>
				</observers>
			</sales_order_creditmemo_save_after>
		</events>
		<pdf>
			<totals>
				<reward translate='title'>
					<title>Reward Points</title>
					<source_field>reward_currency_amount</source_field>
					<font_size>7</font_size>
					<display_zero>0</display_zero>
					<sort_order>650</sort_order>
					<amount_prefix>-</amount_prefix>
				</reward>
			</totals>
		</pdf>
	</global>
	<admin>
		<routers>
			<adminhtml>
				<args>
					<modules>
						<reward before='Mage_Adminhtml'>Df_Reward_Adminhtml</reward>
					</modules>
				</args>
			</adminhtml>
		</routers>
	</admin>
	<adminhtml>
		<layout>
			<updates>
				<df_reward><file>df/reward.xml</file></df_reward>
			</updates>
		</layout>
		<translate>
			<modules>
				<Df_Reward><files><default>Df_Reward.csv</default></files></Df_Reward>
			</modules>
		</translate>
		<events>
			<core_layout_update_updates_get_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>disableLayout</method>
					</df_reward>
				</observers>
			</core_layout_update_updates_get_after>
			<adminhtml_customer_prepare_save>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>saveRewardNotifications</method>
					</df_reward>
				</observers>
			</adminhtml_customer_prepare_save>
			<adminhtml_customer_save_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>saveRewardPoints</method>
					</df_reward>
				</observers>
			</adminhtml_customer_save_after>
			<review_save_commit_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>reviewSubmit</method>
					</df_reward>
				</observers>
			</review_save_commit_after>
			<tag_save_commit_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>tagSubmit</method>
					</df_reward>
				</observers>
			</tag_save_commit_after>
			<adminhtml_sales_order_create_process_data>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>processOrderCreationData</method>
					</df_reward>
				</observers>
			</adminhtml_sales_order_create_process_data>
			<adminhtml_sales_order_creditmemo_register_before>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>setRewardPointsBalanceToRefund</method>
					</df_reward>
				</observers>
			</adminhtml_sales_order_creditmemo_register_before>
			<website_delete_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>prepareCustomerOrphanPoints</method>
					</df_reward>
				</observers>
			</website_delete_after>
			<adminhtml_block_salesrule_actions_prepareform>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>prepareSalesruleForm</method>
					</df_reward>
				</observers>
			</adminhtml_block_salesrule_actions_prepareform>
			<salesrule_rule_load_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>loadRewardSalesruleData</method>
					</df_reward>
				</observers>
			</salesrule_rule_load_after>
			<salesrule_rule_save_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>saveRewardSalesruleData</method>
					</df_reward>
				</observers>
			</salesrule_rule_save_after>
		</events>
	</adminhtml>
	<frontend>
		<layout>
			<updates>
				<df_reward><file>df/reward.xml</file></df_reward>
			</updates>
		</layout>
		<translate>
			<modules>
				<Df_Reward><files><default>Df_Reward.csv</default></files></Df_Reward>
			</modules>
		</translate>
		<routers>
			<df_reward>
				<use>standard</use>
				<args>
					<module>Df_Reward</module>
					<frontName>reward</frontName>
				</args>
			</df_reward>
		</routers>
		<events>
			<core_block_abstract_to_html_after>
				<observers>
					<df_reward__core_block_abstract_to_html_after>
						<class>df_reward/dispatcher</class>
						<method>core_block_abstract_to_html_after</method>
					</df_reward__core_block_abstract_to_html_after>
				</observers>
			</core_block_abstract_to_html_after>
			<customer_session_init>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>checkRates</method>
					</df_reward>
				</observers>
			</customer_session_init>
			<customer_save_before>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>customer_save_before</method>
					</df_reward>
				</observers>
			</customer_save_before>
			<customer_save_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>customerRegister</method>
					</df_reward>
				</observers>
			</customer_save_after>
			<payment_method_is_active>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>preparePaymentMethod</method>
					</df_reward>
				</observers>
			</payment_method_is_active>
			<sales_quote_payment_import_data_before>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>paymentDataImport</method>
					</df_reward>
				</observers>
			</sales_quote_payment_import_data_before>
			<sales_order_place_before>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>processBeforeOrderPlace</method>
					</df_reward>
				</observers>
			</sales_order_place_before>
			<sales_order_place_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>processOrderPlace</method>
					</df_reward>
				</observers>
			</sales_order_place_after>
			<df_invitation_save_commit_after>
				<observers>
					<df_reward>
						<class>df_reward/observer</class>
						<method>invitationToCustomer</method>
					</df_reward>
				</observers>
			</df_invitation_save_commit_after>
			<!--
				Система присылает сообщение «sales_quote_collect_totals_before»
				перед расчётом ценовых правил.
			-->
			<sales_quote_collect_totals_before>
				<observers>
					<df_reward__sales_quote_collect_totals_before>
						<!--
							Модуль при получении сообщения «sales_quote_collect_totals_before»
							обнуляет свои счётчики
							применимых к корзине правил с накопительными скидками
						-->
						<class>df_reward/dispatcher</class>
						<method>sales_quote_collect_totals_before</method>
					</df_reward__sales_quote_collect_totals_before>
				</observers>
			</sales_quote_collect_totals_before>
			<salesrule_validator_process>
				<observers>
					<df_reward__validator_process>
						<!--
							Подсчитываем применимые к корзине правила с накопительными скидками
						-->
						<class>df_reward/dispatcher</class>
						<method>salesrule_validator_process</method>
					</df_reward__validator_process>
				</observers>
			</salesrule_validator_process>
		</events>
	</frontend>
	<default>
		<df_reward>
			<general>
				<enabled>0</enabled>
				<enabled_on_front>0</enabled_on_front>
				<publish_history>1</publish_history>
				<expiry_calculation>static</expiry_calculation>
				<landing_page>reward-points</landing_page>
			</general>
			<notification>
				<email_sender>general</email_sender>
				<subscribe_by_default>1</subscribe_by_default>
				<balance_update_template>df_reward_notification_balance_update_template</balance_update_template>
				<expiry_warning_template>df_reward_notification_expiry_warning_template</expiry_warning_template>
			</notification>
		</df_reward>
		<sales>
			<totals_sort>
				<reward>80</reward>
			</totals_sort>
		</sales>
	</default>
	<crontab>
		<jobs>
			<!--df_reward_balance_warning_notification>
				<schedule><cron_expr>1 * * * *</cron_expr></schedule>
				<run><model>df_reward/observer::scheduledBalanceExpireNotification</model></run>
			</df_reward_balance_warning_notification-->
			<df_reward_expire_points>
				<schedule><cron_expr>1 * * * *</cron_expr></schedule>
				<run><model>df_reward/observer::scheduledPointsExpiration</model></run>
			</df_reward_expire_points>
		</jobs>
	</crontab>
	<df>
		<features>
			<df-reward>
				<module>df_reward</module>
				<title>Накопительная программа</title>
				<url>http://magento-forum.ru/forum/185/</url>
			</df-reward>
		</features>
	</df>
</config>
